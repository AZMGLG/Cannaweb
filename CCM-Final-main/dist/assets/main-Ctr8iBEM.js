(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();class S{constructor(){this.supportedLanguages=["en","es","de","pt","it"],this.currentLanguage="en",this.cache=new Map,this.originalTexts=new Map,this.isTranslating=!1,this.rateLimitCount=0,this.maxRateLimitErrors=3,this.apiHealth={libretranslate:{failures:0,lastFailure:0,disabled:!1},libretranslate_alt:{failures:0,lastFailure:0,disabled:!1},mymemory:{failures:0,lastFailure:0,disabled:!1}},this.maxFailures=5,this.failureTimeout=1e4,this.healthCheckInterval=setInterval(()=>this.checkAndReenableApis(),5e3),this.apis={libretranslate:{name:"LibreTranslate",url:"https://libretranslate.de/translate",enabled:!0,freeLimit:1/0,priority:1,timeout:5e3},libretranslate_alt:{name:"LibreTranslate Alt",url:"https://translate.argosopentech.com/translate",enabled:!0,freeLimit:1/0,priority:2,timeout:5e3},microsoft:{name:"Microsoft Translator",url:"https://api.cognitive.microsofttranslator.com/translate",key:"",region:"",enabled:!1,freeLimit:2e6,priority:3},deepl:{name:"DeepL",url:"https://api-free.deepl.com/v2/translate",key:"",enabled:!1,freeLimit:5e5,priority:4},mymemory:{name:"MyMemory",url:"https://api.mymemory.translated.net/get",enabled:!0,freeLimit:1e3,priority:5}},this.translatableSelectors=["h1","h2","h3","h4","h5","h6","p","span","div","a","li","td","th","label","button","strong","em","small","blockquote","figcaption","legend"],this.excludeSelectors=["script","style","noscript","code","pre",".lang-btn",".language-switcher",".nav-toggle","[data-no-translate]"],this.init()}async init(){const e=localStorage.getItem("cannabis-madrid-language"),t=this.detectBrowserLanguage();this.currentLanguage=e||t||"en",this.storeOriginalTexts(),this.updateLanguageSwitcher(),this.currentLanguage!=="en"&&await this.translateAllElements()}detectBrowserLanguage(){const t=(navigator.language||navigator.userLanguage).split("-")[0];return this.supportedLanguages.includes(t)?t:"en"}storeOriginalTexts(){this.getTranslatableElements().forEach(t=>{const s=this.extractText(t);s&&s.trim().length>0&&this.originalTexts.set(t,s)})}getTranslatableElements(){const e=[];return this.translatableSelectors.forEach(t=>{document.querySelectorAll(t).forEach(n=>{this.shouldExcludeElement(n)||e.push(n)})}),e}shouldExcludeElement(e){for(const s of this.excludeSelectors)if(e.matches(s))return!0;let t=e.parentElement;for(;t;){for(const s of this.excludeSelectors)if(t.matches(s))return!0;t=t.parentElement}return!1}extractText(e){if(e.children.length===0)return e.textContent;let t="";return Array.from(e.childNodes).forEach(s=>{s.nodeType===Node.TEXT_NODE&&(t+=s.textContent)}),t.trim()}async translateText(e,t){if(t==="en")return e;const s=`${e}_${t}`;if(this.cache.has(s))return this.cache.get(s);const n=this.getHealthyApis();for(const[r,c]of n)try{const i=await this.callTranslationAPI(r,c,e,t);if(i&&i!==e)return this.cache.set(s,i),this.recordApiSuccess(r),i}catch(i){console.warn(`${c.name} failed:`,i.message),this.recordApiFailure(r);continue}return console.warn("All translation APIs failed, returning original text"),e}getHealthyApis(){return Object.entries(this.apis).filter(([e,t])=>t.enabled&&!this.apiHealth[e]?.disabled).sort((e,t)=>e[1].priority-t[1].priority)}checkAndReenableApis(){const e=Date.now();Object.keys(this.apiHealth).forEach(t=>{const s=this.apiHealth[t];s.disabled&&e-s.lastFailure>this.failureTimeout&&(console.log(`Re-enabling ${t} after timeout`),s.disabled=!1,s.failures=0)})}recordApiSuccess(e){this.apiHealth[e]&&(this.apiHealth[e].failures=0,this.apiHealth[e].disabled=!1)}recordApiFailure(e){this.apiHealth[e]&&(this.apiHealth[e].failures++,this.apiHealth[e].lastFailure=Date.now(),this.apiHealth[e].failures>=this.maxFailures&&(this.apiHealth[e].disabled=!0,console.warn(`${e} disabled due to ${this.maxFailures} consecutive failures`)))}async callTranslationAPI(e,t,s,n){switch(e){case"libretranslate":case"libretranslate_alt":return await this.translateLibreTranslate(t,s,n);case"microsoft":return await this.translateMicrosoft(t,s,n);case"deepl":return await this.translateDeepL(t,s,n);case"mymemory":return await this.translateMyMemory(t,s,n);default:throw new Error(`Unknown API: ${e}`)}}async translateMicrosoft(e,t,s){if(!e.key||!e.region)throw new Error("Microsoft Translator API key or region not configured");const n=await fetch(`${e.url}?api-version=3.0&to=${s}`,{method:"POST",headers:{"Ocp-Apim-Subscription-Key":e.key,"Ocp-Apim-Subscription-Region":e.region,"Content-Type":"application/json"},body:JSON.stringify([{text:t}])});if(!n.ok)throw new Error(`Microsoft API error: ${n.status}`);return(await n.json())[0]?.translations[0]?.text||t}async translateDeepL(e,t,s){if(!e.key)throw new Error("DeepL API key not configured");const n=await fetch(e.url,{method:"POST",headers:{Authorization:`DeepL-Auth-Key ${e.key}`,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({text:t,target_lang:s.toUpperCase(),source_lang:"EN"})});if(!n.ok)throw new Error(`DeepL API error: ${n.status}`);return(await n.json()).translations[0]?.text||t}async translateLibreTranslate(e,t,s){const n=e.timeout||5e3,r=new AbortController,c=setTimeout(()=>r.abort(),n);try{const i=await fetch(e.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:t,source:"en",target:s,format:"text"}),signal:r.signal});if(clearTimeout(c),!i.ok)throw i.status===429||i.status===503?new Error(`LibreTranslate overloaded (${i.status})`):new Error(`LibreTranslate API error: ${i.status}`);const u=await i.json();if(u.error)throw new Error(`LibreTranslate error: ${u.error}`);return u.translatedText||t}catch(i){throw clearTimeout(c),i.name==="AbortError"?new Error("LibreTranslate timeout - switching to fallback"):i}}async translateMyMemory(e,t,s){const n=await fetch(`${e.url}?q=${encodeURIComponent(t)}&langpair=en|${s}`);if(n.status===429)throw new Error("MyMemory rate limited");if(!n.ok)throw new Error(`MyMemory API error: ${n.status}`);const r=await n.json();if(r.responseStatus===200&&r.responseData)return r.responseData.translatedText;throw new Error("MyMemory translation failed")}delay(e){return new Promise(t=>setTimeout(t,e))}async translateElement(e){const t=this.originalTexts.get(e);if(!t)return;const s=await this.translateText(t,this.currentLanguage);if(e.children.length===0)e.textContent=s;else{const n=Array.from(e.childNodes).find(r=>r.nodeType===Node.TEXT_NODE);n?n.textContent=s:e.textContent=s}}async translateAllElements(){if(this.isTranslating)return;this.isTranslating=!0;const e=this.getTranslatableElements();await Promise.all(e.map(t=>this.translateElement(t))),this.isTranslating=!1}restoreOriginalTexts(){this.originalTexts.forEach((e,t)=>{const s=Array.from(t.childNodes).find(n=>n.nodeType===Node.TEXT_NODE);s?s.textContent=e:t.textContent=e})}async changeLanguage(e){if(!this.supportedLanguages.includes(e)){console.error("Unsupported language:",e);return}this.currentLanguage=e,localStorage.setItem("cannabis-madrid-language",e),this.updateLanguageSwitcher(),e==="en"?this.restoreOriginalTexts():await this.translateAllElements(),this.updatePageMeta()}updateLanguageSwitcher(){document.querySelectorAll(".lang-btn").forEach(t=>{t.classList.remove("active"),t.dataset.lang===this.currentLanguage&&t.classList.add("active")})}updatePageMeta(){document.documentElement.lang=this.currentLanguage}configureAPI(e,t,s=null){this.apis[e]&&(this.apis[e].key=t,s&&(this.apis[e].region=s),this.apis[e].enabled=!0,console.log(`${e} API configured successfully`))}getAPIStatus(){return Object.entries(this.apis).map(([e,t])=>({name:t.name,enabled:t.enabled,hasKey:!!t.key,freeLimit:t.freeLimit,health:this.apiHealth[e]||{failures:0,disabled:!1},status:this.getApiStatusText(e)}))}getApiStatusText(e){const t=this.apiHealth[e];if(!t)return"Unknown";if(t.disabled){const s=Math.max(0,this.failureTimeout-(Date.now()-t.lastFailure));return`Disabled (${Math.ceil(s/1e3)}s until retry)`}return t.failures>0?`Degraded (${t.failures}/${this.maxFailures} failures)`:"Healthy"}resetApiHealth(e=null){e?this.apiHealth[e]&&(this.apiHealth[e]={failures:0,lastFailure:0,disabled:!1},console.log(`Reset health for ${e}`)):(Object.keys(this.apiHealth).forEach(t=>{this.apiHealth[t]={failures:0,lastFailure:0,disabled:!1}}),console.log("Reset health for all APIs"))}}const d=new S;document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".lang-btn").forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.lang;d.changeLanguage(t)})})});window.configureTranslationAPI=(a,e,t=null)=>{d.configureAPI(a,e,t)};window.getTranslationAPIStatus=()=>d.getAPIStatus();window.resetTranslationAPIHealth=(a=null)=>{d.resetApiHealth(a)};window.getTranslationHealth=()=>d.apiHealth;const p=document.querySelector(".nav-toggle"),k=document.querySelector(".nav-menu");p.addEventListener("click",()=>{k.classList.toggle("active"),p.classList.toggle("active")});document.querySelectorAll(".nav-link").forEach(a=>{a.addEventListener("click",()=>{k.classList.remove("active"),p.classList.remove("active")})});document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector(this.getAttribute("href"));if(t){const s=t.offsetTop-70;window.scrollTo({top:s,behavior:"smooth"})}})});window.addEventListener("scroll",()=>{const a=document.querySelector(".navbar");window.scrollY>50?(a.style.background="rgba(255, 255, 255, 0.95)",a.style.backdropFilter="blur(10px)"):(a.style.background="#fff",a.style.backdropFilter="none")});const w=document.querySelector(".contact-form form");w&&w.addEventListener("submit",function(a){a.preventDefault(),new FormData(this);const e=this.querySelector('input[type="text"]').value,t=this.querySelector('input[type="email"]').value,s=this.querySelector("textarea").value;if(!e||!t||!s){alert("Please fill in all fields");return}const n=this.querySelector("button"),r=n.textContent;n.textContent="Sending...",n.disabled=!0,setTimeout(()=>{alert("Thank you for your message! We'll get back to you soon."),this.reset(),n.textContent=r,n.disabled=!1},2e3)});const A={threshold:.1,rootMargin:"0px 0px -50px 0px"},I=new IntersectionObserver(a=>{a.forEach(e=>{e.isIntersecting&&(e.target.style.opacity="1",e.target.style.transform="translateY(0)")})},A);document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".product-card, .service-card, .contact-item").forEach(e=>{e.style.opacity="0",e.style.transform="translateY(30px)",e.style.transition="opacity 0.6s ease, transform 0.6s ease",I.observe(e)})});const b=document.querySelector(".whatsapp-link");b&&b.addEventListener("click",()=>{console.log("WhatsApp link clicked - Cannabis Madrid")});window.addEventListener("load",()=>{document.body.style.opacity="0",document.body.style.transition="opacity 0.5s ease",setTimeout(()=>{document.body.style.opacity="1"},100)});window.addEventListener("scroll",()=>{const a=window.pageYOffset,e=document.querySelector(".hero");if(e){const t=a*-.5;e.style.transform=`translateY(${t}px)`}});document.querySelectorAll(".product-card").forEach(a=>{a.addEventListener("mouseenter",function(){this.style.transform="translateY(-10px) scale(1.02)"}),a.addEventListener("mouseleave",function(){this.style.transform="translateY(0) scale(1)"})});document.querySelectorAll(".service-card").forEach(a=>{a.addEventListener("mouseenter",function(){const e=this.querySelector("i");e.style.transform="scale(1.2) rotate(5deg)",e.style.color="#1d4ed8"}),a.addEventListener("mouseleave",function(){const e=this.querySelector("i");e.style.transform="scale(1) rotate(0deg)",e.style.color="#2563eb"})});function x(a,e,t=2e3){let s=0;const n=e/(t/16);function r(){s+=n,s<e?(a.textContent=Math.floor(s)+"+",requestAnimationFrame(r)):a.textContent=e+"+"}r()}const L=new IntersectionObserver(a=>{a.forEach(e=>{e.isIntersecting&&(e.target.querySelectorAll(".stat h3").forEach(s=>{const n=parseInt(s.textContent);x(s,n)}),L.unobserve(e.target))})},{threshold:.5}),E=document.querySelector(".stats");E&&L.observe(E);(function(){const a=document.getElementById("ageVerificationModal"),e=document.getElementById("ageConfirm"),t=document.getElementById("ageDeny");sessionStorage.getItem("ageVerified")||a&&a.classList.remove("hidden"),e&&e.addEventListener("click",function(n){n.preventDefault(),n.stopPropagation(),sessionStorage.setItem("ageVerified","true"),a&&a.classList.add("hidden"),setTimeout(()=>{checkAndShowCookieBanner()},500)}),t&&t.addEventListener("click",function(n){n.preventDefault(),n.stopPropagation(),alert("You must be 18 or older to access this website."),window.location.href="https://www.google.com"})})();(function(){const a=document.getElementById("cookieBanner"),e=document.getElementById("cookieSettingsModal"),t=document.getElementById("cookieAccept"),s=document.getElementById("cookieReject"),n=document.getElementById("cookieSettings"),r=document.getElementById("closeCookieSettings"),c=document.getElementById("saveCookieSettings"),i="cookieConsent",u="cookiePreferences";function h(){return localStorage.getItem(i)!==null}function y(){const o=localStorage.getItem(u);return o?JSON.parse(o):{essential:!0,analytics:!1,marketing:!1}}function g(o){localStorage.setItem(u,JSON.stringify(o)),localStorage.setItem(i,"true")}function v(){a&&!h()&&setTimeout(()=>{a.classList.add("show")},100)}function m(){a&&a.classList.remove("show")}function T(){sessionStorage.getItem("ageVerified")&&!h()&&v()}t&&t.addEventListener("click",function(o){o.preventDefault(),o.stopPropagation();const l={essential:!0,analytics:!0,marketing:!0};g(l),m(),f(l)}),s&&s.addEventListener("click",function(o){o.preventDefault(),o.stopPropagation();const l={essential:!0,analytics:!1,marketing:!1};g(l),m(),f(l)}),n&&n.addEventListener("click",function(o){if(o.preventDefault(),o.stopPropagation(),e){e.classList.add("show");const l=y();document.getElementById("analyticsCookies").checked=l.analytics,document.getElementById("marketingCookies").checked=l.marketing}}),r&&r.addEventListener("click",function(o){o.preventDefault(),o.stopPropagation(),e&&e.classList.remove("show")}),c&&c.addEventListener("click",function(o){o.preventDefault(),o.stopPropagation();const l={essential:!0,analytics:document.getElementById("analyticsCookies").checked,marketing:document.getElementById("marketingCookies").checked};g(l),m(),e&&e.classList.remove("show"),f(l)});function f(o){console.log("Essential cookies: Enabled"),o.analytics?console.log("Analytics cookies: Enabled"):console.log("Analytics cookies: Disabled"),o.marketing?console.log("Marketing cookies: Enabled"):console.log("Marketing cookies: Disabled")}document.addEventListener("DOMContentLoaded",()=>{if(sessionStorage.getItem("ageVerified")&&T(),h()){const l=y();f(l)}}),e&&e.addEventListener("click",o=>{o.target===e&&e.classList.remove("show")})})();
